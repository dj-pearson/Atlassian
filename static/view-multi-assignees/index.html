<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi Assignees View</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@atlaskit/css-reset@^6.0.0/dist/bundle.css"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        margin: 0;
        padding: 8px;
        background-color: transparent;
      }

      .assignees-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .assignee-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        background: #f7f8f9;
        border-left: 3px solid #dfe1e6;
      }

      .assignee-item.primary {
        border-left-color: #0052cc;
        background: #deebff;
      }

      .assignee-item.secondary {
        border-left-color: #00875a;
        background: #e3fcef;
      }

      .assignee-item.reviewer {
        border-left-color: #ff8b00;
        background: #fff4e5;
      }

      .assignee-item.collaborator {
        border-left-color: #6554c0;
        background: #f3f0ff;
      }

      .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #0052cc;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        flex-shrink: 0;
      }

      .user-avatar.primary {
        background: #0052cc;
      }

      .user-avatar.secondary {
        background: #00875a;
      }

      .user-avatar.reviewer {
        background: #ff8b00;
      }

      .user-avatar.collaborator {
        background: #6554c0;
      }

      .user-info {
        flex: 1;
        min-width: 0;
      }

      .user-name {
        font-weight: 500;
        color: #172b4d;
        margin: 0;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .role-badge {
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
      }

      .role-badge.primary {
        background: #0052cc;
        color: white;
      }

      .role-badge.secondary {
        background: #00875a;
        color: white;
      }

      .role-badge.reviewer {
        background: #ff8b00;
        color: white;
      }

      .role-badge.collaborator {
        background: #6554c0;
        color: white;
      }

      .no-assignees {
        text-align: center;
        padding: 16px;
        color: #5e6c84;
        font-style: italic;
        font-size: 13px;
      }

      .assignees-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #f4f5f7;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #5e6c84;
      }

      .assignee-count {
        font-weight: 600;
        color: #172b4d;
      }

      .role-counts {
        display: flex;
        gap: 8px;
      }

      .role-count {
        display: flex;
        align-items: center;
        gap: 2px;
      }

      .role-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
      }

      .role-dot.primary {
        background: #0052cc;
      }
      .role-dot.secondary {
        background: #00875a;
      }
      .role-dot.reviewer {
        background: #ff8b00;
      }
      .role-dot.collaborator {
        background: #6554c0;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #5e6c84;
        font-size: 13px;
      }

      .error {
        text-align: center;
        padding: 20px;
        color: #de350b;
        font-size: 13px;
      }

      /* Compact mode for narrow spaces */
      .compact .assignee-item {
        padding: 4px 8px;
        gap: 6px;
      }

      .compact .user-avatar {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }

      .compact .user-name {
        font-size: 12px;
      }

      .compact .role-badge {
        font-size: 9px;
        padding: 1px 4px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">Loading assignees...</div>
    </div>

    <script src="https://unpkg.com/@forge/bridge@^3.0.0/out/index.js"></script>
    <script>
      let assignees = [];
      let issueKey = "";
      let isCompact = false;

      // Initialize the app
      AP.context.getContext((context) => {
        // Check if we're in a compact context
        isCompact = window.innerWidth < 300;
        if (isCompact) {
          document.body.classList.add("compact");
        }

        loadData();
      });

      async function loadData() {
        try {
          // Get assignee data from Forge resolver
          const data = await AP.request("/view-multi-assignees");

          assignees = data.multiAssignees || [];
          issueKey = data.issueKey || "";

          renderView();
        } catch (error) {
          console.error("Error loading assignees:", error);
          renderError("Failed to load assignees");
        }
      }

      function renderView() {
        const app = document.getElementById("app");

        if (assignees.length === 0) {
          app.innerHTML = `
                    <div class="no-assignees">
                        No multi-assignees configured for this issue
                    </div>
                `;
          return;
        }

        const roleCounts = countRoles();

        app.innerHTML = `
                <div class="assignees-container">
                    ${!isCompact ? renderSummary(roleCounts) : ""}
                    ${assignees
                      .map((assignee) => renderAssignee(assignee))
                      .join("")}
                </div>
            `;
      }

      function renderSummary(roleCounts) {
        return `
                <div class="assignees-summary">
                    <span class="assignee-count">${assignees.length} assignee${
          assignees.length === 1 ? "" : "s"
        }</span>
                    <div class="role-counts">
                        ${
                          roleCounts.primary > 0
                            ? `
                            <div class="role-count">
                                <div class="role-dot primary"></div>
                                <span>${roleCounts.primary}P</span>
                            </div>
                        `
                            : ""
                        }
                        ${
                          roleCounts.secondary > 0
                            ? `
                            <div class="role-count">
                                <div class="role-dot secondary"></div>
                                <span>${roleCounts.secondary}S</span>
                            </div>
                        `
                            : ""
                        }
                        ${
                          roleCounts.reviewer > 0
                            ? `
                            <div class="role-count">
                                <div class="role-dot reviewer"></div>
                                <span>${roleCounts.reviewer}R</span>
                            </div>
                        `
                            : ""
                        }
                        ${
                          roleCounts.collaborator > 0
                            ? `
                            <div class="role-count">
                                <div class="role-dot collaborator"></div>
                                <span>${roleCounts.collaborator}C</span>
                            </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;
      }

      function renderAssignee(assignee) {
        const user = assignee.user || { displayName: "Unknown User" };
        const initials = getInitials(user.displayName);

        return `
                <div class="assignee-item ${assignee.role}">
                    <div class="user-avatar ${assignee.role}">
                        ${initials}
                    </div>
                    <div class="user-info">
                        <p class="user-name" title="${user.displayName}">
                            ${user.displayName}
                        </p>
                    </div>
                    <div class="role-badge ${assignee.role}">
                        ${assignee.role}
                    </div>
                </div>
            `;
      }

      function getInitials(displayName) {
        if (!displayName) return "?";

        const parts = displayName.trim().split(/\s+/);
        if (parts.length === 1) {
          return parts[0].charAt(0).toUpperCase();
        } else {
          return (
            parts[0].charAt(0) + parts[parts.length - 1].charAt(0)
          ).toUpperCase();
        }
      }

      function countRoles() {
        return assignees.reduce(
          (counts, assignee) => {
            counts[assignee.role] = (counts[assignee.role] || 0) + 1;
            return counts;
          },
          { primary: 0, secondary: 0, reviewer: 0, collaborator: 0 }
        );
      }

      function renderError(message) {
        document.getElementById("app").innerHTML = `
                <div class="error">${message}</div>
            `;
      }

      // Handle window resize for responsive design
      window.addEventListener("resize", () => {
        const wasCompact = isCompact;
        isCompact = window.innerWidth < 300;

        if (wasCompact !== isCompact) {
          document.body.classList.toggle("compact", isCompact);
          renderView();
        }
      });
    </script>
  </body>
</html>
