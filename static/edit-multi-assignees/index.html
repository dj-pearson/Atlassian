<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Multi Assignees</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@atlaskit/css-reset@^6.0.0/dist/bundle.css"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        margin: 0;
        padding: 16px;
        background-color: #f7f8f9;
      }

      .assignee-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 16px;
      }

      .assignee-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 16px;
      }

      .assignee-title {
        font-size: 16px;
        font-weight: 600;
        color: #172b4d;
        margin: 0;
      }

      .smart-suggest-btn {
        background: #0052cc;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .smart-suggest-btn:hover {
        background: #0065ff;
      }

      .assignee-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
      }

      .assignee-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border: 2px solid #dfe1e6;
        border-radius: 6px;
        background: #fafbfc;
      }

      .assignee-item.primary {
        border-color: #0052cc;
        background: #deebff;
      }

      .assignee-item.secondary {
        border-color: #00875a;
        background: #e3fcef;
      }

      .assignee-item.reviewer {
        border-color: #ff8b00;
        background: #fff4e5;
      }

      .assignee-item.collaborator {
        border-color: #6554c0;
        background: #f3f0ff;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #0052cc;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .user-info {
        flex: 1;
      }

      .user-name {
        font-weight: 500;
        color: #172b4d;
        margin: 0;
      }

      .user-email {
        font-size: 12px;
        color: #5e6c84;
        margin: 0;
      }

      .role-selector {
        padding: 6px 12px;
        border: 1px solid #dfe1e6;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 14px;
      }

      .remove-btn {
        background: #de350b;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
      }

      .remove-btn:hover {
        background: #ff5630;
      }

      .add-assignee {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 16px;
      }

      .user-search {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #dfe1e6;
        border-radius: 4px;
        font-size: 14px;
      }

      .user-search:focus {
        outline: none;
        border-color: #0052cc;
      }

      .add-btn {
        background: #00875a;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
      }

      .add-btn:hover {
        background: #36b37e;
      }

      .add-btn:disabled {
        background: #dfe1e6;
        color: #5e6c84;
        cursor: not-allowed;
      }

      .capacity-info {
        background: #f4f5f7;
        border: 1px solid #dfe1e6;
        border-radius: 4px;
        padding: 12px;
        margin-top: 16px;
      }

      .capacity-text {
        font-size: 14px;
        color: #5e6c84;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .suggestions-panel {
        background: white;
        border: 1px solid #dfe1e6;
        border-radius: 8px;
        margin-top: 16px;
        padding: 16px;
        display: none;
      }

      .suggestions-header {
        font-size: 14px;
        font-weight: 600;
        color: #172b4d;
        margin-bottom: 12px;
      }

      .suggestion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 8px;
      }

      .suggestion-item:hover {
        background: #f4f5f7;
      }

      .suggestion-score {
        background: #0052cc;
        color: white;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .save-btn {
        background: #0052cc;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        margin-top: 20px;
      }

      .save-btn:hover {
        background: #0065ff;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #5e6c84;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">Loading Multi-Assignee Editor...</div>
    </div>

    <script src="https://unpkg.com/@forge/bridge@^3.0.0/out/index.js"></script>
    <script>
      let assignees = [];
      let availableUsers = [];
      let suggestions = [];
      let currentIssue = null;

      // Initialize the app
      AP.context.getContext((context) => {
        loadData();
      });

      async function loadData() {
        try {
          // Get initial data from Forge resolver
          const data = await AP.request("/edit-multi-assignees");

          currentIssue = data.issue;
          assignees = data.multiAssignees || [];
          availableUsers = data.availableUsers || [];

          renderApp();
        } catch (error) {
          console.error("Error loading data:", error);
          renderError("Failed to load multi-assignee data");
        }
      }

      function renderApp() {
        const app = document.getElementById("app");
        app.innerHTML = `
                <div class="assignee-container">
                    <div class="assignee-header">
                        <h3 class="assignee-title">Assignees (${
                          assignees.length
                        }/8)</h3>
                        <button class="smart-suggest-btn" onclick="toggleSuggestions()">
                            âš¡ Smart Suggest
                        </button>
                    </div>
                    
                    <div class="assignee-list">
                        ${assignees
                          .map((assignee, index) =>
                            renderAssignee(assignee, index)
                          )
                          .join("")}
                    </div>
                    
                    <div class="add-assignee">
                        <input type="text" class="user-search" placeholder="Search users..." 
                               onkeyup="filterUsers(this.value)" />
                        <select id="new-user-select" class="role-selector">
                            <option value="">Select User</option>
                            ${availableUsers
                              .map(
                                (user) => `
                                <option value="${user.accountId}">${user.displayName}</option>
                            `
                              )
                              .join("")}
                        </select>
                        <select id="new-role-select" class="role-selector">
                            <option value="secondary">Secondary</option>
                            <option value="primary">Primary</option>
                            <option value="reviewer">Reviewer</option>
                            <option value="collaborator">Collaborator</option>
                        </select>
                        <button class="add-btn" onclick="addAssignee()">Add</button>
                    </div>
                    
                    <div class="capacity-info">
                        <p class="capacity-text">
                            ðŸ“Š Total capacity: ${calculateTotalCapacity()}h â€¢ 
                            ${
                              assignees.filter((a) => a.role === "primary")
                                .length
                            } Primary â€¢ 
                            ${
                              assignees.filter((a) => a.role === "secondary")
                                .length
                            } Secondary â€¢ 
                            ${
                              assignees.filter((a) => a.role === "reviewer")
                                .length
                            } Reviewers
                        </p>
                    </div>
                    
                    <div id="suggestions-panel" class="suggestions-panel">
                        <div class="suggestions-header">ðŸŽ¯ Suggested Assignees</div>
                        <div id="suggestions-content"></div>
                    </div>
                    
                    <button class="save-btn" onclick="saveAssignees()">Save Changes</button>
                </div>
            `;
      }

      function renderAssignee(assignee, index) {
        const user = availableUsers.find(
          (u) => u.accountId === assignee.userAccountId
        ) || { displayName: "Unknown User", emailAddress: "" };

        return `
                <div class="assignee-item ${assignee.role}">
                    <div class="user-avatar">
                        ${user.displayName.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-info">
                        <p class="user-name">${user.displayName}</p>
                        <p class="user-email">${user.emailAddress || ""}</p>
                    </div>
                    <select class="role-selector" onchange="updateRole(${index}, this.value)">
                        <option value="primary" ${
                          assignee.role === "primary" ? "selected" : ""
                        }>Primary</option>
                        <option value="secondary" ${
                          assignee.role === "secondary" ? "selected" : ""
                        }>Secondary</option>
                        <option value="reviewer" ${
                          assignee.role === "reviewer" ? "selected" : ""
                        }>Reviewer</option>
                        <option value="collaborator" ${
                          assignee.role === "collaborator" ? "selected" : ""
                        }>Collaborator</option>
                    </select>
                    <button class="remove-btn" onclick="removeAssignee(${index})">Remove</button>
                </div>
            `;
      }

      function addAssignee() {
        const userSelect = document.getElementById("new-user-select");
        const roleSelect = document.getElementById("new-role-select");

        if (!userSelect.value) {
          alert("Please select a user");
          return;
        }

        if (assignees.length >= 8) {
          alert("Maximum 8 assignees allowed");
          return;
        }

        // Check if user already assigned
        if (assignees.some((a) => a.userAccountId === userSelect.value)) {
          alert("User is already assigned to this issue");
          return;
        }

        assignees.push({
          userAccountId: userSelect.value,
          role: roleSelect.value,
          assignedDate: new Date().toISOString(),
          estimatedHours: 4,
        });

        userSelect.value = "";
        renderApp();
      }

      function removeAssignee(index) {
        assignees.splice(index, 1);
        renderApp();
      }

      function updateRole(index, newRole) {
        assignees[index].role = newRole;
        renderApp();
      }

      function calculateTotalCapacity() {
        return assignees.reduce(
          (total, assignee) => total + (assignee.estimatedHours || 4),
          0
        );
      }

      async function toggleSuggestions() {
        const panel = document.getElementById("suggestions-panel");

        if (panel.style.display === "none" || !panel.style.display) {
          // Load suggestions
          try {
            const data = await AP.request("/assignee-suggestions");
            suggestions = data.suggestions || [];
            renderSuggestions();
            panel.style.display = "block";
          } catch (error) {
            console.error("Error loading suggestions:", error);
          }
        } else {
          panel.style.display = "none";
        }
      }

      function renderSuggestions() {
        const content = document.getElementById("suggestions-content");
        content.innerHTML = suggestions
          .map(
            (suggestion) => `
                <div class="suggestion-item" onclick="applySuggestion('${
                  suggestion.user.accountId
                }', '${suggestion.suggestedRole}')">
                    <div class="user-avatar">
                        ${suggestion.user.displayName.charAt(0).toUpperCase()}
                    </div>
                    <div class="user-info">
                        <p class="user-name">${suggestion.user.displayName}</p>
                        <p class="user-email">${suggestion.reasons.join(
                          ", "
                        )}</p>
                    </div>
                    <div class="suggestion-score">${Math.round(
                      suggestion.score * 100
                    )}%</div>
                </div>
            `
          )
          .join("");
      }

      function applySuggestion(userAccountId, role) {
        if (assignees.some((a) => a.userAccountId === userAccountId)) {
          alert("User is already assigned");
          return;
        }

        assignees.push({
          userAccountId,
          role,
          assignedDate: new Date().toISOString(),
          estimatedHours: 4,
        });

        document.getElementById("suggestions-panel").style.display = "none";
        renderApp();
      }

      function filterUsers(query) {
        // Simple client-side filtering for demo
        const select = document.getElementById("new-user-select");
        const options = Array.from(select.options);

        options.forEach((option) => {
          if (option.value === "") return;
          const user = availableUsers.find((u) => u.accountId === option.value);
          const matches =
            user &&
            user.displayName.toLowerCase().includes(query.toLowerCase());
          option.style.display = matches ? "block" : "none";
        });
      }

      async function saveAssignees() {
        try {
          // Save to Jira issue properties
          const response = await AP.request({
            url: `/rest/api/3/issue/${currentIssue.key}/properties/multi-assignees`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({
              assignees,
              metadata: {
                lastModified: new Date().toISOString(),
                version: 1,
              },
            }),
          });

          // Track analytics
          await AP.request({
            url: "/analytics-webhook",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              eventType: "multiAssigneeUpdated",
              issueKey: currentIssue.key,
              assigneeCount: assignees.length,
              rolesUsed: [...new Set(assignees.map((a) => a.role))],
            }),
          });

          // Close dialog
          AP.dialog.close();
        } catch (error) {
          console.error("Error saving assignees:", error);
          alert("Failed to save changes. Please try again.");
        }
      }

      function renderError(message) {
        document.getElementById("app").innerHTML = `
                <div class="assignee-container">
                    <p style="color: #de350b; text-align: center;">${message}</p>
                </div>
            `;
      }
    </script>
  </body>
</html>
